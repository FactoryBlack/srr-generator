<script>
// Collect a specific key amount and log
function collectKey(data, color, amount) {
    if (!data.keys[color]) {
        logMessage(`Error: Key color '${color}' is not defined in data.keys.`);
        return;
    }
    data.keys[color].real += amount.real;
    data.keys[color].imag += amount.imag;
    logMessage(`Collected ${amount.real !== 0 ? amount.real : ''}${amount.imag !== 0 ? (amount.real !== 0 ? ' + ' : '') + amount.imag + 'i' : ''} ${color} key(s). Total: ${data.keys[color].real} + ${data.keys[color].imag}i`);
}

// Check auras with logging
function checkAuras(data) {
    let greenAuraActive = false;
    let redAuraActive = false;
    let blueAuraActive = false;
    let brownAuraActive = false;

    if (data.keys.red.real >= 1) {
        logMessage("Red aura activated! Frozen doors can be defrosted.");
        redAuraActive = true;
    } else {
        logMessage("Red aura not active.");
    }

    if (data.keys.green.real >= 5) {
        logMessage("Green aura activated! Eroded doors can be healed.");
        greenAuraActive = true;
    } else {
        logMessage("Green aura not active.");
    }

    if (data.keys.blue.real >= 3) {
        logMessage("Blue aura activated! Painted doors can be cleaned.");
        blueAuraActive = true;
    } else {
        logMessage("Blue aura not active.");
    }

    if (data.keys.brown.real < 0) {
        logMessage("Negative brown aura activated! Curses can now be removed from nearby doors.");
        brownAuraActive = true;
    }

    return { greenAuraActive, redAuraActive, blueAuraActive, brownAuraActive };
}

// Open doors with aura checks and logging
function openDoor(data, door, auras) {
    logMessage(`Attempting to open ${door.color} door. Type: ${door.type}, Corrupted: ${door.corrupted}`);

    if (door.type === 'frozen' && door.corrupted) {
        if (auras.redAuraActive) {
            logMessage(`Defrosted frozen ${door.color} door with red aura.`);
            door.corrupted = false;
        } else {
            logMessage(`Cannot defrost frozen ${door.color} door. Red aura not active.`);
            return false;
        }
    }

    if (door.type === 'eroded' && door.corrupted) {
        if (auras.greenAuraActive) {
            logMessage(`Healed eroded ${door.color} door with green aura.`);
            door.corrupted = false;
        } else {
            logMessage(`Cannot heal eroded ${door.color} door. Green aura not active.`);
            return false;
        }
    }

    if (door.type === 'painted' && door.corrupted) {
        if (auras.blueAuraActive) {
            logMessage(`Cleaned painted ${door.color} door with blue aura.`);
            door.corrupted = false;
        } else {
            logMessage(`Cannot clean painted ${door.color} door. Blue aura not active.`);
            return false;
        }
    }

    if (door.type === 'cursed') {
        if (auras.brownAuraActive) {
            logMessage(`Opened cursed ${door.color} door using negative brown aura.`);
            door.copies -= 1;
            logMessage(`Remaining copies: ${door.copies}`);
            return true;
        } else {
            logMessage(`Cannot open cursed ${door.color} door without negative brown aura.`);
            return false;
        }
    }

    for (const lock of door.locks) {
        const { color, cost } = lock;
        if (!data.keys[color]) {
            logMessage(`Error: Key color '${color}' is not defined in data.keys.`);
            return false;
        }
        data.keys[color].real -= cost.real;
        data.keys[color].imag -= cost.imag;
        logMessage(`Used ${cost.real !== 0 ? cost.real : ''}${cost.imag !== 0 ? (cost.real !== 0 ? ' + ' : '') + cost.imag + 'i' : ''} ${color} key(s) to open part of ${door.color} door.`);
    }

    door.copies -= 1;
    logMessage(`Opened ${door.color} door. Remaining copies: ${door.copies}`);
    return true;
}

// Goal check with detailed logging
function checkGoal(data) {
    const remainingDoors = data.doors.filter(door => door.copies > 0 || door.corrupted);
    if (remainingDoors.length === 0) {
        data.goal.reached = true;
        logMessage("Goal reached! All necessary doors are open.");
    } else {
        const remainingDescriptions = remainingDoors.map(door => `${door.color} (Copies: ${door.copies}, Corrupted: ${door.corrupted})`);
        logMessage("Goal not yet reached. Remaining doors to be opened or uncorrupted: " + remainingDescriptions.join(", "));
    }
}

// Solver function
async function cursedDoorTest() {
    logMessage("Starting solver...");

    const testData = cloneData(puzzleData);
    for (const key of testData.keysToCollect) {
        collectKey(testData, key.color, key.amount);
    }

    const auras = checkAuras(testData);

    for (const door of testData.doors) {
        openDoor(testData, door, auras);
    }

    checkGoal(testData);
}

document.getElementById("startButton").addEventListener("click", cursedDoorTest);
</script>
